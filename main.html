<!DOCTYPE html>
<html lang="en">
<head>
    <title>X-Post Analyzer Pro ✨</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- Enhanced Color Palette --- */
            --bg-color: #0f0f0f; /* Even deeper base background */
            --bg-gradient-start: #1a1a1a; /* Start color for body gradient */
            --container-bg: #1c1c1c; /* Slightly different container */
            --card-bg: #242424; /* Card background - slightly lighter */
            --text-color: #e5e5e5; /* Brighter main text */
            --text-color-secondary: #a5a5a5; /* Slightly brighter secondary text */
            --primary-color: #1DA1F2; /* X blue */
            --primary-color-darker: #0c84d4;
            --primary-glow: rgba(29, 161, 242, 0.2); /* Glow effect color */
            --secondary-color: #2cc26b; /* More vibrant green */
            --warning-color: #ffc837; /* Brighter yellow */
            --tips-color: #20c997;   /* Vibrant teal */
            --border-color: #3a3a3a; /* Slightly more visible border */
            --progress-bg: #383838;
            --error-bg: #5a2525; /* Deeper red bg */
            --error-border: #c77070; /* Lighter red border */
            --error-text: #fee;
            --shadow-color: rgba(0, 0, 0, 0.5); /* Stronger shadow */
             /* Custom property for progress bar color */
            --progress-value-color: var(--secondary-color);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
             /* Subtle Gradient Background */
            background: linear-gradient(170deg, var(--bg-gradient-start) 0%, var(--bg-color) 100%);
            background-attachment: fixed; /* Keep gradient fixed during scroll */
            color: var(--text-color);
            padding: 40px 20px; /* Increased vertical padding */
            line-height: 1.65; /* Slightly more line height */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh; /* Ensure gradient covers full height */
        }

        .main-container {
            display: flex;
            max-width: 1350px; /* Wider */
            margin: 30px auto;
            gap: 35px; /* Increased gap */
            background-color: var(--container-bg);
            padding: 35px; /* Increased padding */
            border-radius: 20px; /* Softer radius */
             /* Enhanced Shadow */
            box-shadow: 0 12px 45px var(--shadow-color), 0 0 15px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
        }

        .left-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 30px; /* Increased gap */
        }

        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .input-section, .score-section, .analysis-section, .example-posts-section, .post-card, .error-message-popup {
            background-color: var(--card-bg);
            padding: 30px; /* Increased padding */
            border-radius: 16px; /* Softer radius */
            border: 1px solid var(--border-color);
             /* More subtle card shadow */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.25);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
         .input-section:hover, .score-section:hover, .analysis-section:hover, .example-posts-section:hover, .post-card:hover {
              /* Slight lift on hover */
             /* transform: translateY(-2px); */
             box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
         }


         .error-message-popup {
             background-color: var(--error-bg);
             border-color: var(--error-border);
             color: var(--error-text);
             margin-bottom: 25px;
             border-left: 5px solid var(--error-border);
             padding: 20px 25px;
         }
         .error-message-popup h2 {
             color: #f8baba; /* Lighter red heading */
             /* Removed border-bottom from error heading */
             font-size: 1.25em;
             margin-bottom: 12px;
             display: flex;
             align-items: center;
             gap: 8px;
             border-bottom: none; /* Explicitly remove border */
             padding-bottom: 0; /* Remove padding */
         }
         .error-message-popup p {
             margin: 0;
             line-height: 1.6;
             font-size: 0.95em;
         }

        h1, h2, h3 {
            color: var(--text-color);
            margin-top: 0;
            font-weight: 600;
        }
         h1 {
             font-size: 2.4em; /* Larger H1 */
             text-align: center;
             margin-bottom: 30px;
             font-weight: 700;
             color: #fff; /* Brightest H1 */
             letter-spacing: -0.5px; /* Slightly tighter */
         }
         h2 {
             font-size: 1.5em; /* Larger H2 */
             color: var(--primary-color); /* Using primary X blue */
             border-bottom: 2px solid var(--border-color);
             padding-bottom: 15px;
             margin-bottom: 25px;
             font-weight: 700; /* Bolder H2 */
             letter-spacing: -0.2px;
         }
         h3 {
            font-size: 1.2em; /* Larger H3 */
            margin-bottom: 15px;
            font-weight: 600;
            color: #d8d8d8; /* Slightly brighter H3 */
         }

        textarea, button {
            width: 100%;
            padding: 15px 20px; /* Increased padding */
            margin-bottom: 20px;
            border-radius: 10px; /* Softer radius */
            font-size: 1rem; /* Base font size */
            font-family: inherit;
            box-sizing: border-box;
            background-color: #2d2d2d; /* Slightly lighter input bg */
            color: var(--text-color);
            border: 1px solid #555;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        textarea {
            min-height: 140px; /* Taller textarea */
            resize: vertical;
            line-height: 1.6;
        }
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px var(--primary-glow); /* Glow effect */
        }
        textarea::placeholder { color: #888; }

        button {
            /* Enhanced Gradient Button */
            background: linear-gradient(120deg, var(--primary-color), var(--primary-color-darker));
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1em; /* Slightly larger */
            transition: all 0.3s ease; /* Smooth transition for all properties */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
            text-transform: uppercase; /* Uppercase text */
        }
        button:hover:not(:disabled) {
             background: linear-gradient(120deg, var(--primary-color-darker), #0a7ac4);
             box-shadow: 0 6px 15px rgba(29, 161, 242, 0.4); /* Brighter shadow on hover */
             transform: translateY(-2px); /* Lift effect */
        }
        button:active:not(:disabled) {
             transform: translateY(0px) scale(0.98); /* Press down effect */
             box-shadow: 0 2px 5px rgba(0,0,0, 0.3);
        }
        button:disabled {
             background: linear-gradient(120deg, #555, #444);
             cursor: not-allowed;
             opacity: 0.6;
             box-shadow: none;
             transform: none;
        }

        .score-section {
            display: flex;
            align-items: center;
            gap: 45px; /* Increased gap */
            padding: 35px; /* More padding */
        }

        .global-score {
            text-align: center;
            flex-shrink: 0;
            padding-right: 30px;
        }
        .global-score .score-value {
            font-size: 3.8em; /* Larger score */
            font-weight: 700;
            /* Dynamic color will be applied via JS based on value */
            color: var(--secondary-color);
            line-height: 1;
            margin-bottom: 8px;
            transition: color 0.5s ease;
        }
        .global-score .score-label {
            font-size: 1em;
            color: var(--text-color-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }

        .component-scores {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 18px; /* Increased gap */
        }
        .score-item {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .score-item label {
            width: 115px; /* Wider labels */
            font-size: 1em;
            flex-shrink: 0;
            font-weight: 500;
            color: #c5c5c5;
        }
        progress {
            flex-grow: 1;
            height: 16px; /* Thicker progress bar */
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #444; /* Subtle border */
            background-color: var(--progress-bg);
            accent-color: var(--progress-value-color); /* Fallback */
            transition: background-color 0.5s ease;
        }
        progress::-webkit-progress-bar {
            background-color: var(--progress-bg);
            border-radius: 8px;
        }
        progress::-webkit-progress-value {
            background: var(--progress-value-color); /* Use variable */
            border-radius: 8px 0 0 8px; /* Keep start rounded */
             /* Smooth Gradient Progress */
            background: linear-gradient(90deg, var(--progress-value-color), color-mix(in srgb, var(--progress-value-color) 80%, #fff 20%));
            transition: background 0.5s ease, width 0.5s ease;
        }
        progress::-moz-progress-bar {
            background: var(--progress-value-color); /* Use variable */
            border-radius: 8px;
             /* Smooth Gradient Progress */
            background: linear-gradient(90deg, var(--progress-value-color), color-mix(in srgb, var(--progress-value-color) 80%, #fff 20%));
            transition: background 0.5s ease, width 0.5s ease;
        }

        .score-item .score-percentage {
            font-size: 1.05em; /* Larger percentage */
            font-weight: 600;
            min-width: 50px; /* More space */
            text-align: right;
            color: var(--text-color);
        }

        .analysis-section {
            padding-top: 15px;
        }

        .analysis-section p, .analysis-section ul {
             margin-bottom: 20px;
             color: var(--text-color-secondary);
             line-height: 1.75; /* Increased line height */
        }
         .analysis-section h3 + p, .analysis-section h3 + ul {
             margin-top: 8px;
         }
        .analysis-section ul {
            list-style: none;
            padding: 0;
            margin: 0 0 20px 5px;
        }
        .analysis-section li {
            margin-bottom: 14px;
            padding-left: 35px; /* More space for icon */
            position: relative;
            color: var(--text-color); /* Brighter list items */
            font-size: 0.98rem;
        }
        .analysis-section li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 2px; /* Fine-tune vertical alignment */
            font-size: 1.35em; /* Larger icons */
            line-height: 1;
            display: inline-block;
            width: 25px;
            text-align: center;
            font-weight: normal; /* Use normal weight for emojis */
        }

        /* Emojis as Icons */
        .features li::before { content: '✅'; /* Checkmark */ }
        .opportunities li::before { content: '💡'; color: var(--warning-color); }
        .tips li::before { content: '🛠️'; color: var(--tips-color); }
        .factors li::before { content: '⚙️'; color: #ccc; }


        .loading {
            display: none;
            text-align: center;
            padding: 30px 0; /* More padding */
            color: var(--text-color-secondary);
            align-items: center;
            justify-content: center;
            gap: 15px;
            font-size: 1.15em;
        }
        .spinner {
             /* Enhanced Spinner */
             width: 36px;
             height: 36px;
             border-radius: 50%;
             display: inline-block;
             border-top: 4px solid var(--primary-color);
             border-right: 4px solid transparent;
             animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .response-area {
            min-height: 50px;
            opacity: 0;
            transform: translateY(15px); /* Start slightly lower */
            transition: opacity 0.7s cubic-bezier(0.25, 0.8, 0.25, 1), transform 0.7s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother transition */
            display: none; /* Start hidden */
        }
         .response-area.visible {
             opacity: 1;
             transform: translateY(0);
             display: block; /* Default */
         }
         .score-section.visible {
             display: flex; /* Override for flex */
         }


         .post-card {
             font-size: 1rem; /* Base font size */
             line-height: 1.6;
             margin-bottom: 20px;
             border: 1px solid var(--border-color);
             padding: 25px;
             background-color: #2a2a2a; /* Slightly different bg */
             border-radius: 12px;
             position: relative; /* For potential absolute elements later */
             transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
         }
          .post-card:hover {
              background-color: #303030;
              border-color: #484848;
              box-shadow: 0 6px 18px rgba(0,0,0,0.3);
          }
         .post-card:last-child {
             margin-bottom: 0;
         }
         .post-card .author {
             font-weight: 700; /* Bolder */
             margin-bottom: 15px;
             color: var(--primary-color);
             font-size: 1.1em;
             display: block;
             border-bottom: 1px solid #444; /* Slightly lighter separator */
             padding-bottom: 10px;
             letter-spacing: 0.3px;
         }
         .post-card .content {
             margin-bottom: 18px;
             white-space: pre-wrap; /* Keep line breaks */
             color: var(--text-color);
         }
         .post-card .stats { /* Label */
             font-size: 0.88em;
             color: var(--text-color-secondary);
             text-align: right;
             font-style: italic;
         }

        /* Responsive adjustments */
        @media (max-width: 1000px) {
             .main-container {
                 flex-direction: column;
                 padding: 25px;
                 gap: 30px;
             }
             .left-panel, .right-panel {
                 flex: none;
                 width: 100%;
             }
        }
         @media (max-width: 600px) {
             body { padding: 20px 10px; }
             .main-container { padding: 15px; gap: 20px; border-radius: 15px;}
             .input-section, .score-section, .analysis-section, .example-posts-section, .post-card, .error-message-popup { padding: 20px; border-radius: 12px;}
             .score-section { flex-direction: column; gap: 30px; align-items: stretch; padding: 25px;}
             .global-score { margin-bottom: 15px; padding-right: 0; }
             .global-score .score-value {font-size: 3.2em;}
             .score-item label { width: 100px; font-size: 0.95em;}
             .score-item .score-percentage { font-size: 1em; }
             h1 { font-size: 1.9em; margin-bottom: 20px;}
             h2 { font-size: 1.35em; padding-bottom: 12px; margin-bottom: 20px;}
             h3 { font-size: 1.15em; }
             .analysis-section li { padding-left: 30px; margin-bottom: 12px; font-size: 0.95rem;}
             .analysis-section li::before { width: 22px; top: 3px; font-size: 1.2em;}
             .post-card { padding: 20px; }
             .post-card .author {font-size: 1.05em;}
             .post-card .content { font-size: 0.95em; }
             textarea, button { padding: 14px 18px; font-size: 0.95rem;}
             textarea { min-height: 120px; }
             button { font-size: 1em; }
         }

         /* Style for Debug Log */
         .debug-log {
             background-color: #111;
             color: #ddd;
             padding: 15px;
             margin-top: 15px;
             border-radius: 8px;
             border: 1px dashed #555;
             font-family: monospace;
             font-size: 0.85em;
             white-space: pre-wrap; /* Keep formatting */
             max-height: 300px; /* Limit height */
             overflow-y: auto; /* Add scrollbar if needed */
         }
         .debug-log strong {
             color: var(--warning-color);
         }

    </style>
    <!-- Puter.com script -->
    <script src="https://js.puter.com/v2/"></script>
</head>
<body>

    <div class="main-container">
        <div class="left-panel">
            <h1>X-Post Analyzer Pro ✨</h1>
            <div class="input-section">
                <h2>Analyze Your Draft</h2>
                <textarea id="post-content" rows="6" placeholder="Paste your X (Twitter) post text here... e.g., Exploring the future of AI ethics. It's complex, but crucial we get it right. What's one ethical challenge that concerns you most? #AI #Ethics #FutureTech"></textarea>
                <button id="analyze-button">Analyze Post</button>
                <div id="loading" class="loading">
                    <div class="spinner"></div>
                    <span>Deep Analyzing with AI...</span>
                </div>
            </div>

            <!-- Container for potential error messages -->
            <div id="error-message-container" class="response-area"></div>

            <div class="score-section response-area" id="score-area">
                <div class="global-score">
                    <div id="global-score-value" class="score-value">--</div>
                    <div class="score-label">Global Score</div>
                </div>
                <div class="component-scores">
                    <div class="score-item">
                        <label for="engagement-score">Engagement</label>
                        <progress id="engagement-score" value="0" max="100"></progress>
                        <span id="engagement-score-perc" class="score-percentage">--%</span>
                    </div>
                    <div class="score-item">
                        <label for="friendliness-score">Friendliness</label>
                        <progress id="friendliness-score" value="0" max="100"></progress>
                        <span id="friendliness-score-perc" class="score-percentage">--%</span>
                    </div>
                    <div class="score-item">
                        <label for="virality-score">Virality</label>
                        <progress id="virality-score" value="0" max="100"></progress>
                        <span id="virality-score-perc" class="score-percentage">--%</span>
                    </div>
                </div>
            </div>

            <div class="analysis-section response-area" id="analysis-area">
                 <h2>Algorithm Analysis</h2>

                 <div id="performance-overview">
                    <h3>Performance Overview</h3>
                    <p>Analysis details will appear here...</p>
                 </div>

                 <div id="algo-features" class="features">
                    <h3>Algorithm-Friendly Features</h3>
                    <ul><li>Pending analysis...</li></ul>
                 </div>

                 <div id="algo-opportunities" class="opportunities">
                    <h3>Algorithm Optimization Opportunities</h3>
                    <ul><li>Pending analysis...</li></ul>
                 </div>

                 <div id="algo-tips" class="tips">
                     <h3>Algorithm Optimization Tips</h3>
                     <ul><li>Pending analysis...</li></ul>
                 </div>

                 <div id="algo-factors" class="factors">
                     <h3>Key Algorithm Factors (General)</h3>
                     <ul><li>Pending analysis...</li></ul>
                 </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="example-posts-section response-area" id="examples-area">
                <h2>Example Optimized Posts</h2>
                <div id="example-posts-container">
                    <!-- Example posts will be loaded here -->
                    <p>Examples will appear here...</p>
                </div>
                 <!-- DEBUG AREA for Example Post Raw Content -->
                 <div id="example-debug-container"></div>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Element References ---
        const analyzeButton = document.getElementById('analyze-button');
        const postContentInput = document.getElementById('post-content');
        const loadingDiv = document.getElementById('loading');
        const errorMessageContainer = document.getElementById('error-message-container');

        // Response Area Containers
        const scoreArea = document.getElementById('score-area');
        const analysisArea = document.getElementById('analysis-area');
        const examplesArea = document.getElementById('examples-area');
        const responseAreas = [scoreArea, analysisArea, examplesArea, errorMessageContainer];

        // Specific Result Elements
        const globalScoreValue = document.getElementById('global-score-value');
        const engagementScoreProgress = document.getElementById('engagement-score');
        const engagementScorePerc = document.getElementById('engagement-score-perc');
        const friendlinessScoreProgress = document.getElementById('friendliness-score');
        const friendlinessScorePerc = document.getElementById('friendliness-score-perc');
        const viralityScoreProgress = document.getElementById('virality-score');
        const viralityScorePerc = document.getElementById('virality-score-perc');
        const performanceOverviewDiv = document.getElementById('performance-overview');
        const algoFeaturesUl = document.querySelector('#algo-features ul');
        const algoOpportunitiesUl = document.querySelector('#algo-opportunities ul');
        const algoTipsUl = document.querySelector('#algo-tips ul');
        const algoFactorsUl = document.querySelector('#algo-factors ul');
        const examplePostsContainer = document.getElementById('example-posts-container');
        const exampleDebugContainer = document.getElementById('example-debug-container'); // <-- DEBUG

        // --- Configuration ---
        const analysisModel = "openrouter:openai/o3"; // Recommended model
        // const analysisModel = "openai/gpt-4o"; // Alternative

        // --- Initial Content ---
        // Use a default message that reflects the theme of the original images
        const initialTweetContent = `Feeling a bit under the weather today. 🤒 Just one of those days you want to curl up and recharge. Anyone else relate? What's your go-to comfort activity?`;

        // --- Event Listener ---
        analyzeButton.addEventListener('click', handleAnalysisRequest);

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
             postContentInput.value = initialTweetContent;
             clearPreviousResults();
             if (!postContentInput.value) {
                 postContentInput.placeholder = "Paste your X (Twitter) post text here...";
             }
         });

        // --- Main Analysis Function ---
        async function handleAnalysisRequest() {
            const postContent = postContentInput.value.trim();

            if (!postContent) {
                displayErrorMessage('Post content cannot be empty. Please paste your text.');
                return;
            }

            clearPreviousResults();
            showLoading(true);

            // ** Build the prompt **
            const analysisPrompt = buildAnalysisPromptWithExamples(postContent);
            console.log("Sending prompt (first 200 chars):", analysisPrompt.substring(0, 200) + "...");

            try {
                const rawResponse = await puter.ai.chat(analysisPrompt, { model: analysisModel });
                const responseText = extractTextFromResponse(rawResponse);
                console.log("Received response text length:", responseText?.length);

                if (!responseText || responseText.trim().length < 100) {
                     // Try parsing even short responses, might just be missing examples
                     console.warn(`Received short response from AI (Length: ${responseText?.length}). Attempting to parse anyway.`);
                     // throw new Error(`Received very short or empty response from AI (Length: ${responseText?.length}). Model might be unavailable or prompt/format issue.`);
                }

                parseAndDisplayResponse(responseText); // This will now handle potential missing sections
                showResponseAreas(true, true); // Show results even if some parts are missing

            } catch (error) {
                console.error("Error during analysis:", error);
                displayErrorMessage(`Analysis failed. Could not get a valid response from the AI model (${analysisModel}). <br>Possible reasons: AI service issue, network problem, or prompt format error. <br>Details: ${error.message}. Check console (F12) for more info.`);
                showResponseAreas(false, false);
                errorMessageContainer.classList.add('visible');
                errorMessageContainer.style.display = 'block';
            } finally {
                showLoading(false);
            }
        }

        // --- Helper Functions ---

        function buildAnalysisPromptWithExamples(postContent) {
            // ** NEW: Pre-defined "cool" examples related to the "under the weather" theme **
            const examplePost1 = `Kinda dragging today, ngl. 🥱 Sometimes you just gotta call a timeout & hit reset. What's your non-negotiable recharge ritual when you're feeling drained? Spill the beans! 👇`;
            const examplePost2 = `Running on low battery today 🔋 but powering through *gently*. Quick reminder: self-care isn't selfish, it's essential maintenance! What’s one tiny victory you’re aiming for today to lift your spirits? ✨`;
            const examplePost3 = `Yeah, feeling under the weather is a definite mood killer. 🤒 But hey, it's okay to not be 100%. Give yourself permission to just *be* for a bit. The bounce-back is always stronger. 💪 What helps you ride out the low-energy waves?`;
            const examplePost4 = `Anyone else feel like their internal 'check engine' light is blinking today? 😂 Definitely need a system reboot over here. Taking it easy & focusing on the small stuff. Drop your top quick mood boosters! Need some inspo. 🙏`;
            const examplePost5 = `Definitely feeling a bit off-kilter today. Channeling major reset vibes. 🧘‍♀️ Sometimes you just gotta lean into the quiet & trust the process. Tomorrow's a fresh start. What’s one good thing (big or small) lighting up your day today? ☀️`;

            return `
Act as a world-class X (formerly Twitter) algorithm strategist and viral content philosopher. Analyze the following post draft with extreme scrutiny. Focus on maximizing reach, genuine engagement (meaningful replies, saves, clicks), depth of thought, and positive algorithmic signals based on CURRENT best practices (as of mid-2024). Assume the algorithm prioritizes quality interaction, dwell time, and authentic conversation over simple metrics.

Post Draft:
---
${postContent}
---

Provide your detailed analysis STRICTLY in the following format. Use the exact headings and Markdown lists. Do NOT add any fluff, intro, or conclusion outside this structure. Scores MUST be integers between 0 and 100. Base scores on predicted algorithmic performance AND the potential for genuine human connection/impact.

### Global Score:
[Integer Score 0-100]

### Engagement Score:
[Integer Score 0-100]

### Friendliness Score:
[Integer Score 0-100]

### Virality Score:
[Integer Score 0-100]

### Performance Overview:
[Concise (3-4 sentence) executive summary.]

### Algorithm-Friendly Features:
[Specific list using '-' bullet points.]
- Example: Uses open-ended question.
- [...]

### Algorithm Optimization Opportunities:
[Specific list using '-' bullet points.]
- Example: Lacks specific anecdote.
- [...]

### Algorithm Optimization Tips:
[Specific list using '-' bullet points, explaining rationale.]
- Example: Add a micro-story. *Why:* Increases resonance.
- [...]

### Key Algorithm Factors (General):
[Specific list using '-' or '**...**:' format.]
- Engagement Quality & Velocity: ...
- Dwell Time: ...
- [...]

### Example Optimized Posts:
**[CRITICAL INSTRUCTION: You MUST provide exactly the FIVE (5) example posts below, formatted EXACTLY as shown. Each example MUST start on a brand new line with "Example N:" (where N is 1 to 5), followed immediately by the post content on the same line or the next line. DO NOT add any other text, introductions, explanations, or modifications to these specific five examples in this section.]**

Example 1: ${examplePost1}

Example 2: ${examplePost2}

Example 3: ${examplePost3}

Example 4: ${examplePost4}

Example 5: ${examplePost5}
`;
        }


        function extractTextFromResponse(rawResponse) {
             // (Same reliable extractor)
             console.log("Raw API Response Type:", typeof rawResponse);

             if (typeof rawResponse === 'object' && rawResponse !== null && rawResponse.message && typeof rawResponse.message.content === 'string') {
                 return rawResponse.message.content;
             }
             else if (typeof rawResponse === 'object' && rawResponse !== null) {
                 if (Array.isArray(rawResponse.choices) && rawResponse.choices.length > 0) {
                     const firstChoice = rawResponse.choices[0];
                     if (firstChoice.message && typeof firstChoice.message.content === 'string') {
                         return firstChoice.message.content;
                     }
                     if (typeof firstChoice.text === 'string') {
                         return firstChoice.text;
                     }
                 }
                 if (typeof rawResponse.text === 'string') return rawResponse.text;
                 if (typeof rawResponse.content === 'string') return rawResponse.content;

                 console.warn("AI response object structure not recognized. Stringifying.", rawResponse);
                 try { return JSON.stringify(rawResponse); } catch (e) { console.error("Could not stringify the AI response object.", e); return ""; }
             }
             else if (typeof rawResponse === 'string') {
                 return rawResponse;
             }
             else {
                 console.error("Unexpected response type or null response from AI:", typeof rawResponse, rawResponse);
                 return "";
             }
         }


        function parseAndDisplayResponse(responseString) {
             // Handle potential null/undefined response early
             if (typeof responseString !== 'string') {
                 console.error("Invalid input to parseAndDisplayResponse: Expected a string, got", typeof responseString);
                 displayErrorMessage("Internal error: Received invalid data type from AI.");
                 resetResultDisplay(); // Clear any previous results
                 showResponseAreas(false, false); // Ensure areas are hidden
                 errorMessageContainer.classList.add('visible'); // Show error container
                 errorMessageContainer.style.display = 'block';
                 return;
             }
             // If string is empty or only whitespace
              if (responseString.trim() === '') {
                  console.warn("Received empty response string from AI. Displaying message.");
                  displayErrorMessage("The AI returned an empty response. This might be a temporary issue with the service.");
                  resetResultDisplay(); // Clear any previous results
                  showResponseAreas(false, false); // Ensure areas are hidden
                  errorMessageContainer.classList.add('visible'); // Show error container
                  errorMessageContainer.style.display = 'block';
                  return;
              }

             const normalizedResponse = responseString.replace(/\r\n/g, '\n');
             const lines = normalizedResponse.split('\n');
             const sections = {};
             let currentSection = null;
             let buffer = [];

             // Define section keys based on the prompt structure
             const sectionKeys = [
                 "Global Score",
                 "Engagement Score",
                 "Friendliness Score",
                 "Virality Score",
                 "Performance Overview",
                 "Algorithm-Friendly Features",
                 "Algorithm Optimization Opportunities",
                 "Algorithm Optimization Tips",
                 "Key Algorithm Factors (General)",
                 "Example Optimized Posts" // Crucial: Case-sensitive match
             ];
             let currentSectionKey = null; // Use the exact key from sectionKeys

             for (const line of lines) {
                 const trimmedLine = line.trim();
                 let foundHeading = false;

                 for (const key of sectionKeys) {
                     // Match heading: ### Key Name : optional colon
                     const headingRegex = new RegExp(`^###\\s+${key.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\s*:?\\s*$`, 'i'); // Case-insensitive match
                     if (headingRegex.test(trimmedLine)) {
                         if (currentSectionKey && buffer.length > 0) {
                             sections[currentSectionKey] = buffer.join('\n').trim();
                         }
                         currentSectionKey = key; // Store the exact key
                         buffer = [];
                         console.log(`Found section heading matching key: ${currentSectionKey}`);
                         foundHeading = true;
                         break; // Stop checking keys for this line
                     }
                 }

                 if (!foundHeading && currentSectionKey) {
                     buffer.push(line); // Preserve original line format if inside a section
                 }
             }
             // Capture the last section
             if (currentSectionKey && buffer.length > 0) {
                 sections[currentSectionKey] = buffer.join('\n').trim();
             }

             console.log("Parsed Section Keys found:", Object.keys(sections));

             // --- Update DOM (handle missing sections gracefully) ---
             resetResultDisplay(); // Clear previous stuff first

             const parseScore = (sectionName) => {
                 const sectionContent = sections[sectionName];
                 if (!sectionContent) {
                      console.warn(`Score section "${sectionName}" not found in parsed data.`);
                      return 0; // Default to 0 if missing
                 }
                 // Regex improved: handles potential surrounding text better, ensures digits
                 const scoreMatch = sectionContent.match(/[^0-9]|^(\d{1,3})[^0-9%]|%/);
                 const scoreStr = scoreMatch?.[1] || sectionContent.trim().match(/^(\d{1,3})$/)?.[1]; // Try matching if it's the only content
                 if (scoreStr) {
                     return parseInt(scoreStr, 10);
                 } else {
                     console.warn(`Could not parse score value from section "${sectionName}":`, sectionContent);
                     return 0; // Default to 0 if parsing fails
                 }
             };

             const gs = parseScore('Global Score');
             const es = parseScore('Engagement Score');
             const fs = parseScore('Friendliness Score');
             const vs = parseScore('Virality Score');

             globalScoreValue.textContent = gs !== 0 ? gs : '--'; // Show '--' if score is 0 (likely missing/unparsed)
             if (gs === 0) globalScoreValue.style.color = 'var(--text-color-secondary)'; // Default color if no score
             else if (gs < 40) globalScoreValue.style.color = 'var(--warning-color)';
             else if (gs < 70) globalScoreValue.style.color = 'var(--tips-color)';
             else globalScoreValue.style.color = 'var(--secondary-color)';

             updateProgress(engagementScoreProgress, engagementScorePerc, es);
             updateProgress(friendlinessScoreProgress, friendlinessScorePerc, fs);
             updateProgress(viralityScoreProgress, viralityScorePerc, vs);

             updateTextSection(performanceOverviewDiv, 'Performance Overview', sections['Performance Overview']); // Uses default if missing
             updateList(algoFeaturesUl, sections['Algorithm-Friendly Features']); // Uses default if missing
             updateList(algoOpportunitiesUl, sections['Algorithm Optimization Opportunities']); // Uses default if missing
             updateList(algoTipsUl, sections['Algorithm Optimization Tips']); // Uses default if missing
             updateList(algoFactorsUl, sections['Key Algorithm Factors (General)']); // Uses default if missing

             // --- Example Posts Section ---
             const exampleContentRaw = sections['Example Optimized Posts'];

             // ** DEBUGGING: Display raw content for examples section **
             exampleDebugContainer.innerHTML = ''; // Clear previous debug info
             const debugDiv = document.createElement('div');
             debugDiv.className = 'debug-log';
             debugDiv.innerHTML = `<strong>Raw Content for 'Example Optimized Posts' Section:</strong>\n\n`;
             if (exampleContentRaw) {
                 // Display escaped content to see exactly what was received
                 debugDiv.innerHTML += exampleContentRaw.replace(/</g, "<").replace(/>/g, ">");
             } else {
                 debugDiv.innerHTML += '<strong>Section not found or content is empty/null.</strong>';
             }
             exampleDebugContainer.appendChild(debugDiv);
             console.log("--- Raw content being sent to updateExamplePosts ---");
             console.log(exampleContentRaw || "[Section Content is Empty or Undefined]");
             console.log("--- End raw content ---");

             // Call the parser function, passing the raw content (could be undefined/null)
             updateExamplePosts(examplePostsContainer, exampleContentRaw);
         }


        function updateProgress(progressBar, percElement, value) {
            const clampedValue = Math.max(0, Math.min(100, value || 0)); // Ensure value is number, default 0
            progressBar.value = clampedValue;
            percElement.textContent = `${clampedValue}%`;

            let colorVar;
             const lowThreshold = 40;
             const medThreshold = 70;
             const highColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-color').trim();
             const medColor = getComputedStyle(document.documentElement).getPropertyValue('--tips-color').trim();
             const lowColor = getComputedStyle(document.documentElement).getPropertyValue('--warning-color').trim();

             // Set color based on value, default to secondary if value is 0 (likely missing)
             if (clampedValue === 0) { colorVar = 'var(--text-color-secondary)'; }
             else if (clampedValue < lowThreshold) { colorVar = lowColor; }
             else if (clampedValue < medThreshold) { colorVar = medColor; }
             else { colorVar = highColor; }

            progressBar.style.setProperty('--progress-value-color', colorVar);
            progressBar.style.accentColor = colorVar; // Fallback
        }

         function updateTextSection(divElement, title, content) {
             // Use a default message if content is falsy (null, undefined, empty string)
             const textContent = content || `No ${title.toLowerCase()} provided or recognized in the AI response.`;
             divElement.innerHTML = ''; // Clear previous
             const h3 = document.createElement('h3');
             h3.textContent = title;
             divElement.appendChild(h3);
             const p = document.createElement('p');
             // Basic HTML escaping and newline conversion
             p.innerHTML = textContent
                 .replace(/</g, "<")
                 .replace(/>/g, ">")
                 .replace(/\n/g, '<br>');
             divElement.appendChild(p);
         }

        function updateList(ulElement, content) {
             ulElement.innerHTML = ''; // Clear previous
             if (!content) {
                 ulElement.innerHTML = `<li>No specific items provided or recognized for this section.</li>`;
                 return;
             }
             const items = content.split('\n');
             let itemCount = 0;
             items.forEach(item => {
                 const trimmedItem = item.trim();
                 // Regex improved slightly for robustness: handles *, -, digits. Captures main content.
                 const match = trimmedItem.match(/^[-*]\s+(.*)|^\d+[\.\)]\s+(.*)|^(\*\*.+?\*\*):\s*(.*)/);
                 let textContent = '';

                 if (match) {
                     // Combine capture groups that might contain the content
                     textContent = match[1] || match[2] || (match[3] && match[4] ? `<strong>${match[3].replace(/\*\*/g,'')}</strong>: ${match[4]}` : match[3]?.replace(/\*\*/g,'')) || '';
                 } else if (trimmedItem && !trimmedItem.startsWith('###') && trimmedItem.length > 3) {
                     // Fallback for lines that don't start with common list markers but look like content
                     textContent = trimmedItem;
                 }

                 textContent = textContent.trim(); // Trim the extracted text

                 if (textContent) {
                     const li = document.createElement('li');
                     // Basic HTML escaping for safety before setting innerHTML
                     li.innerHTML = textContent.replace(/</g, "<").replace(/>/g, ">");
                     ulElement.appendChild(li);
                     itemCount++;
                 }
             });

             if (itemCount === 0) {
                 // If parsing resulted in no items, show a message
                 ulElement.innerHTML = `<li>No specific items could be parsed from this section's content.</li>`;
                 console.warn(`updateList: No list items parsed from content:`, content);
             }
         }

        // --- Example Post Parser (Robust) ---
        function updateExamplePosts(container, postsContent) {
            container.innerHTML = ''; // Clear previous results
            console.log("--- Running updateExamplePosts ---");

            // Handle cases where postsContent is missing or empty *before* trying to parse
            if (!postsContent || typeof postsContent !== 'string' || postsContent.trim() === '') {
                console.warn("updateExamplePosts: Received empty or invalid postsContent.");
                container.innerHTML = '<p>No example posts content found or provided by the AI response.</p>';
                 // Display the fallback examples defined in the prompt
                 renderFallbackExamples(container);
                return; // Exit early
            }

            // ** More Robust Regex & Logic **
            // - Looks for "Example" + space(s) + digit + optional colon, at the start of a line.
            // - Captures the rest of that line *and* subsequent lines until the next "Example" or end of string.
            const exampleRegex = /^Example\s+(\d+)\s*:?(.*?)(\n|$)([\s\S]*?)(?=^Example\s+\d|\Z)/gim;
            // Explanation:
            // ^Example\s+(\d+)\s*:?   -> Marker like "Example 1:" at line start
            // (.*?)(\n|$)             -> Captures rest of marker line (non-greedy), handles newline/end
            // ([\s\S]*?)              -> Captures actual post content across lines (non-greedy)
            // (?=^Example\s+\d|\Z)  -> Positive lookahead: stop before next marker or end of string

            let matches = Array.from(postsContent.matchAll(exampleRegex));
            console.log(`updateExamplePosts: Found ${matches.length} potential examples using regex.`);

            if (matches.length === 0) {
                console.warn("updateExamplePosts: No 'Example N:' markers found using complex regex. Trying simpler split.");
                // Fallback: Try splitting by "Example \d:" lines if the complex regex fails
                const lines = postsContent.split('\n');
                const examples = [];
                let currentExampleLines = [];
                let currentExampleNum = 0;
                for (const line of lines) {
                    const markerMatch = line.match(/^Example\s+(\d+)\s*:?\s*(.*)/i);
                    if (markerMatch) {
                        if (currentExampleNum > 0 && currentExampleLines.length > 0) {
                            examples.push({ num: currentExampleNum, content: currentExampleLines.join('\n').trim() });
                        }
                        currentExampleNum = parseInt(markerMatch[1], 10);
                        currentExampleLines = markerMatch[2] ? [markerMatch[2].trim()] : []; // Start with rest of marker line if any
                    } else if (currentExampleNum > 0) {
                        currentExampleLines.push(line); // Add subsequent lines
                    }
                }
                 // Add the last example
                if (currentExampleNum > 0 && currentExampleLines.length > 0) {
                    examples.push({ num: currentExampleNum, content: currentExampleLines.join('\n').trim() });
                }

                console.log(`updateExamplePosts: Found ${examples.length} examples using line splitting fallback.`);

                if (examples.length > 0) {
                    examples.forEach(ex => {
                         if (ex.content) {
                             renderExamplePost(container, `Example ${ex.num}:`, ex.content);
                         }
                     });
                     if (examples.length < 5) {
                        addParsingWarning(container, examples.length);
                     }
                } else {
                    console.error("updateExamplePosts: Failed to parse examples using both regex and line splitting. Displaying raw block and fallbacks.");
                    container.innerHTML = `<p>Could not parse example posts from the AI response. Displaying raw content and default examples:</p>`;
                    renderExamplePost(container, "Unparsed Raw AI Content", postsContent);
                    renderFallbackExamples(container);
                }
                return;
            }

            // Process matches from the primary regex
            let exampleCount = 0;
            matches.forEach(match => {
                const num = match[1];
                const markerLineContent = (match[2] || '').trim(); // Content on the same line as marker
                const subsequentContent = (match[4] || '').trim(); // Content on following lines
                let fullContent = markerLineContent;
                if (subsequentContent) {
                    fullContent = markerLineContent ? markerLineContent + '\n' + subsequentContent : subsequentContent;
                }

                console.log(`updateExamplePosts: Processing Example ${num}. Content Length=${fullContent.length}`);

                if (fullContent) {
                    renderExamplePost(container, `Example ${num}:`, fullContent);
                    exampleCount++;
                } else {
                    console.warn(`updateExamplePosts: Content for Example ${num} appears empty after trimming.`);
                    // Optionally render a placeholder saying content was empty
                     renderExamplePost(container, `Example ${num}:`, "[AI provided no content for this example]");
                }
            });

             if (exampleCount < 5) {
                 addParsingWarning(container, exampleCount);
             }

            console.log(`updateExamplePosts: Successfully rendered ${exampleCount} example posts.`);
            console.log("--- Finished updateExamplePosts ---");
        }

        // Helper to add warning if fewer than 5 examples parsed
        function addParsingWarning(container, count) {
             console.warn(`updateExamplePosts: Rendered only ${count} examples. Expected 5. Check raw content.`);
             const warningP = document.createElement('p');
             warningP.style.color = 'var(--warning-color)';
             warningP.style.fontSize = '0.9em';
             warningP.style.marginTop = '15px';
             warningP.textContent = `Note: Only found ${count} valid examples in the AI response (expected 5). Check the raw content above.`;
             container.appendChild(warningP);
             // Optionally show fallback examples if parsing failed significantly
             if (count < 3) { // Arbitrary threshold
                 renderFallbackExamples(container, true); // Add a header indicating they are fallbacks
             }
        }

        // Helper to render the predefined fallback examples
        function renderFallbackExamples(container, addHeader = false) {
             if (addHeader) {
                 const headerP = document.createElement('p');
                 headerP.style.marginTop = '20px';
                 headerP.style.marginBottom = '10px';
                 headerP.style.fontWeight = 'bold';
                 headerP.textContent = 'Displaying default examples due to parsing issue:';
                 container.appendChild(headerP);
             }
            const fallbackExamples = [
                 `Kinda dragging today, ngl. 🥱 Sometimes you just gotta call a timeout & hit reset. What's your non-negotiable recharge ritual when you're feeling drained? Spill the beans! 👇`,
                 `Running on low battery today 🔋 but powering through *gently*. Quick reminder: self-care isn't selfish, it's essential maintenance! What’s one tiny victory you’re aiming for today to lift your spirits? ✨`,
                 `Yeah, feeling under the weather is a definite mood killer. 🤒 But hey, it's okay to not be 100%. Give yourself permission to just *be* for a bit. The bounce-back is always stronger. 💪 What helps you ride out the low-energy waves?`,
                 `Anyone else feel like their internal 'check engine' light is blinking today? 😂 Definitely need a system reboot over here. Taking it easy & focusing on the small stuff. Drop your top quick mood boosters! Need some inspo. 🙏`,
                 `Definitely feeling a bit off-kilter today. Channeling major reset vibes. 🧘‍♀️ Sometimes you just gotta lean into the quiet & trust the process. Tomorrow's a fresh start. What’s one good thing (big or small) lighting up your day today? ☀️`
            ];
            fallbackExamples.forEach((content, index) => {
                 renderExamplePost(container, `Example ${index + 1}:`, content);
             });
             console.log("Rendered fallback examples.");
        }


        function renderExamplePost(container, title, content) {
            if (!content || !title) return;

            const postDiv = document.createElement('div');
            postDiv.className = 'post-card';

            const authorDiv = document.createElement('div');
            authorDiv.className = 'author';
            // Escape title just in case, though less critical than content
            authorDiv.textContent = title.replace(/</g, "<").replace(/>/g, ">");

            const contentDiv = document.createElement('div');
            contentDiv.className = 'content';
            // Escape content and handle newlines properly for display
            contentDiv.innerHTML = content
                 .replace(/</g, "<") // Escape HTML tags
                 .replace(/>/g, ">")
                 .replace(/\n/g, '<br>'); // Convert newlines to <br> for HTML display

            const statsDiv = document.createElement('div');
            statsDiv.className = 'stats';
            statsDiv.textContent = '✨ AI Optimized Example';

            postDiv.appendChild(authorDiv);
            postDiv.appendChild(contentDiv);
            postDiv.appendChild(statsDiv);
            container.appendChild(postDiv);
        }

        function showLoading(isLoading) {
            loadingDiv.style.display = isLoading ? 'flex' : 'none';
            analyzeButton.disabled = isLoading;
            if (isLoading) {
                // Clear previous results *when loading starts*
                clearPreviousResults();
            }
        }

        function showResponseAreas(isVisible, skipError = false) {
             // Ensure visibility logic correctly handles the initial state and transitions
             responseAreas.forEach(area => {
                 const isErrorArea = area.id === 'error-message-container';
                 const targetDisplay = area.classList.contains('score-section') ? 'flex' : 'block';

                 if (isErrorArea) {
                     // Error area handling: only hide if explicitly told to and skipError is false
                     if (!isVisible && !skipError) {
                         area.classList.remove('visible');
                         setTimeout(() => { if (!area.classList.contains('visible')) area.style.display = 'none'; }, 700); // Hide after transition
                     }
                     // Don't automatically show error area here; displayErrorMessage handles that
                 } else {
                     // Handling for regular result areas
                     if (isVisible) {
                         area.style.display = targetDisplay; // Set display first
                         // Use requestAnimationFrame or tiny timeout to ensure display is applied before adding class
                         requestAnimationFrame(() => {
                             area.classList.add('visible');
                         });
                     } else {
                         area.classList.remove('visible');
                         setTimeout(() => { if (!area.classList.contains('visible')) area.style.display = 'none'; }, 700); // Hide after transition
                     }
                 }
             });
         }


         function displayErrorMessage(message) {
             errorMessageContainer.innerHTML = ''; // Clear previous errors
             const errorPopup = document.createElement('div');
             errorPopup.className = 'error-message-popup';
             // Use innerHTML carefully, ensure message content is safe or escaped if dynamic
             errorPopup.innerHTML = `
                <h2><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>Analysis Problem</h2>
                <p>${message}</p> <!-- Assuming message is simple text or pre-sanitized -->
            `;
             errorMessageContainer.appendChild(errorPopup);
             errorMessageContainer.style.display = 'block'; // Make sure the container is visible
             requestAnimationFrame(() => {
                 errorMessageContainer.classList.add('visible'); // Trigger transition
             });

             // Ensure other results areas are hidden when an error is displayed
             showResponseAreas(false, true); // Hide others, skip hiding the error message itself
         }

         function clearPreviousResults() {
            // Hide all response areas smoothly
            showResponseAreas(false, false); // Hide all, including potential old errors
            // Clear the content *after* the hide transition might have started
            // Use setTimeout to delay clearing content until after fade-out starts
            setTimeout(() => {
                 resetResultDisplay(); // Clear text/progress/examples
                 errorMessageContainer.innerHTML = ''; // Specifically clear error messages
                 errorMessageContainer.classList.remove('visible'); // Ensure class is removed
                 errorMessageContainer.style.display = 'none'; // Ensure display is none
                 exampleDebugContainer.innerHTML = ''; // Clear debug area
            }, 50); // Small delay
         }

         function resetResultDisplay() {
              // Reset scores and progress bars
              globalScoreValue.textContent = '--';
              globalScoreValue.style.color = 'var(--text-color-secondary)'; // Reset color
              updateProgress(engagementScoreProgress, engagementScorePerc, 0);
              updateProgress(friendlinessScoreProgress, friendlinessScorePerc, 0);
              updateProgress(viralityScoreProgress, viralityScorePerc, 0);

             // Reset text sections with placeholder text
             const placeholder = '<p>Pending analysis...</p>';
             performanceOverviewDiv.innerHTML = `<h3>Performance Overview</h3>${placeholder}`;
             algoFeaturesUl.innerHTML = `<li>Pending analysis...</li>`;
             algoOpportunitiesUl.innerHTML = `<li>Pending analysis...</li>`;
             algoTipsUl.innerHTML = `<li>Pending analysis...</li>`;
             algoFactorsUl.innerHTML = `<li>Pending analysis...</li>`;
             examplePostsContainer.innerHTML = `<p>Examples will appear here...</p>`;
             exampleDebugContainer.innerHTML = ''; // Clear debug area

              // Reset progress bar colors explicitly
              const defaultColor = 'var(--text-color-secondary)';
              [engagementScoreProgress, friendlinessScoreProgress, viralityScoreProgress].forEach(pb => {
                 pb.style.setProperty('--progress-value-color', defaultColor);
                 pb.style.accentColor = defaultColor;
              });
         }

    </script>
</body>
</html>
